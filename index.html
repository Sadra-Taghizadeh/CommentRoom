<!DOCTYPE html>
<html
  lang="fa"
  dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0" />
    <title>کامنت روم پیشرفته</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

    <style>
      :root {
        --primary-color: #3b82f6;
        --primary-dark: #2563eb;
        --secondary-color: #f1f5f9;
        --text-color: #1e293b;
        --text-light: #64748b;
        --border-color: #e2e8f0;
        --success-color: #10b981;
        --error-color: #ef4444;
        --warning-color: #f59e0b;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: system-ui, -apple-system, "Segoe UI", Tahoma, sans-serif;
      }

      body {
        background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 2rem;
        color: var(--text-color);
      }

      .comments-container {
        width: 100%;
        max-width: 800px;
        background: white;
        border-radius: 20px;
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        position: relative;
      }

      .comments-header {
        padding: 1.5rem;
        background: var(--primary-color);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .comments-header h1 {
        font-size: 1.5rem;
        font-weight: 600;
      }

      .comments-stats {
        display: flex;
        gap: 1rem;
        font-size: 0.875rem;
      }

      .comments-container__box {
        max-height: 600px;
        overflow-y: auto;
        padding: 1.5rem;
        scrollbar-width: thin;
        scrollbar-color: var(--primary-color) var(--secondary-color);
      }

      .comments-container__box::-webkit-scrollbar {
        width: 8px;
      }

      .comments-container__box::-webkit-scrollbar-track {
        background: var(--secondary-color);
      }

      .comments-container__box::-webkit-scrollbar-thumb {
        background-color: var(--primary-color);
        border-radius: 4px;
      }

      .comment {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }

      .comment:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
      }

      .comment::before {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        width: 4px;
        height: 100%;
        background: var(--primary-color);
        opacity: 0;
        transition: var(--transition);
      }

      .comment:hover::before {
        opacity: 1;
      }

      .comment__header {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
        gap: 1rem;
      }

      .comment__avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--primary-color);
        padding: 2px;
      }

      .comment__info {
        flex: 1;
      }

      .comment__name {
        color: var(--text-color);
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 0.25rem;
      }

      .comment__time {
        color: var(--text-light);
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .comment__time i {
        font-size: 0.75rem;
      }

      .comment__text {
        color: var(--text-color);
        line-height: 1.75;
        margin-bottom: 1rem;
        font-size: 1rem;
      }

      .comment__actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        align-items: center;
        border-top: 1px solid var(--border-color);
        padding-top: 1rem;
        margin-top: 1rem;
      }

      .comment__action-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
        font-size: 0.875rem;
        color: var(--text-light);
      }

      .comment__action-btn:hover {
        background: var(--secondary-color);
        color: var(--primary-color);
      }

      .comment__action-btn i {
        font-size: 1rem;
      }

      .comment__action-btn.liked {
        color: var(--error-color);
      }

      .comments-container__input {
        padding: 1.5rem;
        background: white;
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: 1rem;
        position: relative;
      }

      .input-wrapper {
        flex: 1;
        position: relative;
      }

      #comment-input {
        width: 100%;
        padding: 1rem 1rem 1rem 3rem;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        font-size: 1rem;
        transition: var(--transition);
        background: var(--secondary-color);
      }

      #comment-input:focus {
        outline: none;
        border-color: var(--primary-color);
        background: white;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
      }

      .emoji-picker {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: var(--text-light);
        font-size: 1.25rem;
        transition: var(--transition);
        overflow: visible;
      }

      .emoji-picker:hover {
        color: var(--primary-color);
      }

      .emoji-picker-container {
        position: absolute;
        bottom: 100%;
        left: 0;
        z-index: 100;
        margin-bottom: 0.5rem;
        display: none;
      }

      .emoji-picker-container.show {
        display: block;
      }

      .comments-container__send-btn {
        background: var(--primary-color);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        text-decoration: none;
        font-weight: 600;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border: none;
        cursor: pointer;
      }

      .comments-container__send-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      .comments-container__send-btn:active {
        transform: translateY(0);
      }

      .reply-input {
        margin-top: 1rem;
        display: flex;
        gap: 0.5rem;
        background: var(--secondary-color);
        padding: 1rem;
        border-radius: 12px;
        animation: slideDown 0.3s ease;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .reply-input input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        background: white;
      }

      .reply-input input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
      }

      .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-primary {
        background: var(--primary-color);
        color: white;
      }

      .btn-danger {
        background: var(--error-color);
        color: white;
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        background: white;
        color: var(--text-color);
        box-shadow: var(--shadow-lg);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        z-index: 1000;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .notification.success {
        border-right: 4px solid var(--success-color);
      }

      .notification.error {
        border-right: 4px solid var(--error-color);
      }

      .notification i {
        font-size: 1.25rem;
      }

      .notification.success i {
        color: var(--success-color);
      }

      .notification.error i {
        color: var(--error-color);
      }

      .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: var(--text-light);
      }

      .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: var(--primary-color);
      }

      .empty-state p {
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
      }

      .empty-state span {
        font-size: 0.875rem;
      }

      @media (max-width: 640px) {
        body {
          padding: 1rem;
        }

        .comments-container__input {
          flex-direction: column;
        }

        .comment__actions {
          flex-wrap: wrap;
        }

        .comment__action-btn {
          font-size: 0.75rem;
          padding: 0.4rem 0.8rem;
        }

        .comments-header {
          flex-direction: column;
          gap: 0.5rem;
          align-items: flex-start;
        }

        .comments-stats {
          width: 100%;
          justify-content: space-between;
        }
      }

      .comment__replies {
        margin-top: 1rem;
        padding-left: 2rem;
        border-left: 2px solid var(--border-color);
        transition: all 0.3s ease;
      }

      .comment__toggle-replies-btn {
        background: none;
        border: none;
        color: var(--primary-color);
        cursor: pointer;
        padding: 0.5rem;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }

      .comment__toggle-replies-btn i {
        transition: transform 0.3s ease;
      }

      .comment__toggle-replies-btn.active i {
        transform: rotate(180deg);
      }

      .confirm-dialog {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .confirm-dialog__content {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        max-width: 400px;
        width: 100%;
        text-align: center;
      }

      .confirm-dialog__actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .comment__edit-input {
        width: 100%;
        min-height: 40px;
        font-size: 1rem;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 8px;
        outline: none;
        resize: none;
        overflow-y: hidden;
        transition: all 0.3s ease-in-out;
      }

      .comment__edit-input:focus {
        border-color: #555;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>
  <body>
    <div class="comments-container">
      <div class="comments-header">
        <h1>نظرات کاربران</h1>
        <div class="comments-stats">
          <span
            ><i class="fas fa-comments"></i>
            <span id="total-comments">0</span> نظر</span
          >
          <span
            ><i class="fas fa-heart"></i>
            <span id="total-likes">0</span> لایک</span
          >
        </div>
      </div>
      <div
        class="comments-container__box"
        id="comments-box"
        aria-live="polite">
        <div class="empty-state">
          <i class="far fa-comments"></i>
          <p>هنوز نظری ثبت نشده است</p>
          <span>اولین نفری باشید که نظر می‌دهید!</span>
        </div>
      </div>
      <div class="comments-container__input">
        <div class="input-wrapper">
          <input
            type="text"
            id="comment-input"
            placeholder="نظر خود را وارد کنید..."
            aria-label="Add a comment" />
          <div
            class="emoji-picker"
            id="emoji-trigger">
            <i class="far fa-smile"></i>
          </div>
          <div
            class="emoji-picker-container"
            id="emoji-picker-container">
            <emoji-picker></emoji-picker>
          </div>
        </div>
        <button
          id="send-btn"
          class="comments-container__send-btn">
          <i class="fas fa-paper-plane"></i>
          ارسال
        </button>
      </div>
    </div>

    <div
      id="confirm-dialog"
      class="confirm-dialog">
      <div class="confirm-dialog__content">
        <p id="confirm-dialog-message">آیا از حذف این نظر مطمئن هستید؟</p>
        <div class="confirm-dialog__actions">
          <button
            id="confirm-dialog-yes"
            class="btn btn-primary">
            بله
          </button>
          <button
            id="confirm-dialog-no"
            class="btn btn-danger">
            خیر
          </button>
        </div>
      </div>
    </div>

    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const commentInput = document.getElementById("comment-input");
        const sendButton = document.getElementById("send-btn");
        const commentBox = document.getElementById("comments-box");
        const totalCommentsEl = document.getElementById("total-comments");
        const totalLikesEl = document.getElementById("total-likes");
        const emojiTrigger = document.getElementById("emoji-trigger");
        const emojiPickerContainer = document.getElementById(
          "emoji-picker-container"
        );
        const emojiPicker = document.querySelector("emoji-picker");

        let totalComments = 0;
        let totalLikes = 0;

        // Load comments from localStorage
        loadComments();
        updateStats();

        // Event Listeners
        sendButton.addEventListener("click", submitComment);
        commentInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") submitComment();
        });

        if (emojiPicker) {
          emojiPicker.addEventListener("emoji-click", (event) => {
            const emoji = event.detail.unicode;
            commentInput.value += emoji;
            commentInput.focus();
          });
        }

        emojiTrigger.addEventListener("click", () => {
          emojiPickerContainer.classList.toggle("show");
        });

        // Functions
        function submitComment() {
          const commentText = commentInput.value.trim();
          if (!commentText) {
            showNotification("لطفاً متن نظر را وارد کنید", "error");
            return;
          }

          const newComment = createComment(
            "کاربر ناشناس",
            "https://via.placeholder.com/48",
            new Date().toLocaleString("fa-IR"),
            commentText
          );

          const emptyState = commentBox.querySelector(".empty-state");
          if (emptyState) emptyState.remove();

          commentBox.insertBefore(newComment, commentBox.firstChild);
          commentInput.value = "";
          totalComments++;
          updateStats();
          saveComments();
          setupCommentActions(newComment);
          showNotification("نظر شما با موفقیت ثبت شد", "success");

          emojiPickerContainer.classList.remove("show");
        }

        function createComment(name, image, time, text) {
          const newComment = document.createElement("div");
          newComment.classList.add("comment");
          newComment.innerHTML = `
        <div class="comment__header">
            <img src="${image}" alt="${name}" class="comment__avatar" />
            <div class="comment__info">
                <p class="comment__name">${name}</p>
                <p class="comment__time">
                    <i class="far fa-clock"></i>
                    ${time}
                </p>
            </div>
        </div>
        <p class="comment__text">${text}</p>
        <div class="comment__actions">
            <button class="comment__action-btn comment__like-btn">
                <i class="far fa-heart"></i>
                <span>پسندیدن</span>
            </button>
            <button class="comment__action-btn comment__reply-btn">
                <i class="far fa-comment"></i>
                <span>پاسخ</span>
            </button>
            <button class="comment__action-btn comment__edit-btn">
                <i class="far fa-edit"></i>
                <span>ویرایش</span>
            </button>
            <button class="comment__action-btn comment__delete-btn">
                <i class="far fa-trash-alt"></i>
                <span>حذف</span>
            </button>
        </div>
        <div class="comment__replies" style="display: none;"></div>
        <button class="comment__toggle-replies-btn">
            <i class="fas fa-chevron-down"></i>
            <span>نمایش پاسخ‌ها</span>
        </button>
    `;
          return newComment;
        }

        function setupCommentActions(commentElement) {
          const likeButton = commentElement.querySelector(".comment__like-btn");
          const deleteButton = commentElement.querySelector(
            ".comment__delete-btn"
          );
          const editButton = commentElement.querySelector(".comment__edit-btn");
          const replyButton = commentElement.querySelector(
            ".comment__reply-btn"
          );
          const toggleRepliesButton = commentElement.querySelector(
            ".comment__toggle-replies-btn"
          );
          const repliesContainer =
            commentElement.querySelector(".comment__replies");

          // نمایش/مخفی کردن پاسخ‌ها
          if (toggleRepliesButton && repliesContainer) {
            toggleRepliesButton.addEventListener("click", function () {
              const isHidden = repliesContainer.style.display === "none";
              repliesContainer.style.display = isHidden ? "block" : "none";
              this.classList.toggle("active");
              this.querySelector("span").textContent = isHidden
                ? "مخفی کردن پاسخ‌ها"
                : "نمایش پاسخ‌ها";
            });
          }

          likeButton.addEventListener("click", function () {
            const isLiked = this.classList.toggle("liked");
            const icon = this.querySelector("i");
            if (isLiked) {
              icon.classList.replace("far", "fas");
              totalLikes++;
            } else {
              icon.classList.replace("fas", "far");
              totalLikes--;
            }
            updateStats();
            saveComments();
          });

          function showConfirmDialog(message) {
            return new Promise((resolve) => {
              const confirmDialog = document.getElementById("confirm-dialog");
              const confirmDialogMessage = document.getElementById(
                "confirm-dialog-message"
              );
              const confirmDialogYes =
                document.getElementById("confirm-dialog-yes");
              const confirmDialogNo =
                document.getElementById("confirm-dialog-no");

              confirmDialogMessage.textContent = message;
              confirmDialog.style.display = "flex";

              confirmDialogYes.addEventListener("click", () => {
                confirmDialog.style.display = "none";
                resolve(true);
              });

              confirmDialogNo.addEventListener("click", () => {
                confirmDialog.style.display = "none";
                resolve(false);
              });
            });
          }

          deleteButton.addEventListener("click", async function () {
            const result = await showConfirmDialog(
              "آیا از حذف این نظر مطمئن هستید؟"
            );
            if (result) {
              commentElement.style.opacity = "0";
              setTimeout(() => {
                commentElement.remove();
                totalComments--;
                updateStats();
                saveComments();
                showNotification("نظر با موفقیت حذف شد", "success");
                checkEmptyState(); // بررسی وضعیت empty-state پس از حذف نظر
              }, 300);
            }
          });

          editButton.addEventListener("click", function () {
            handleEditComment(
              editButton,
              commentElement.querySelector(".comment__text")
            );
          });

          replyButton.addEventListener("click", function () {
            const existingReplyInput =
              commentElement.querySelector(".reply-input");
            if (existingReplyInput) {
              existingReplyInput.remove();
              return;
            }

            const replyInput = document.createElement("div");
            replyInput.classList.add("reply-input");
            replyInput.innerHTML = `
            <input type="text" placeholder="پاسخ خود را وارد کنید..." />
            <button class="btn btn-primary send-reply-btn">
                <i class="fas fa-paper-plane"></i>
                ارسال
            </button>
            <button class="btn btn-danger cancel-reply-btn">
                <i class="fas fa-times"></i>
                لغو
            </button>
        `;

            commentElement.appendChild(replyInput);
            replyInput.querySelector("input").focus();

            setupReplyInputActions(replyInput);
          });
        }

        function setupReplyInputActions(replyInput) {
          const sendReplyBtn = replyInput.querySelector(".send-reply-btn");
          const cancelReplyBtn = replyInput.querySelector(".cancel-reply-btn");
          const input = replyInput.querySelector("input");

          sendReplyBtn.addEventListener("click", function () {
            const replyText = input.value.trim();
            if (replyText) {
              const replyDiv = createComment(
                "کاربر ناشناس",
                "https://via.placeholder.com/48",
                new Date().toLocaleString("fa-IR"),
                replyText
              );

              const repliesContainer =
                replyInput.parentElement.querySelector(".comment__replies");
              repliesContainer.appendChild(replyDiv);

              setupCommentActions(replyDiv);
              replyInput.remove();
              totalComments++;
              updateStats();
              saveComments();
              showNotification("پاسخ شما با موفقیت ثبت شد", "success");
            }
          });

          cancelReplyBtn.addEventListener("click", function () {
            replyInput.remove();
          });

          input.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              sendReplyBtn.click();
            }
          });
        }

        function handleEditComment(editButton, textElement) {
          const isEditing = editButton.classList.contains("editing");

          if (isEditing) {
            const textarea = textElement.querySelector("textarea");
            const updatedText = textarea.value.trim();
            if (updatedText) {
              textElement.innerHTML = updatedText;
              showNotification("نظر با موفقیت ویرایش شد", "success");
            }
            editButton.classList.remove("editing");
            editButton
              .querySelector("i")
              .classList.replace("fa-save", "fa-edit");
            editButton.querySelector("span").textContent = "ویرایش";
          } else {
            const currentText = textElement.textContent.trim();
            textElement.innerHTML = `<textarea class="comment__edit-input">${currentText}</textarea>`;
            const textarea = textElement.querySelector("textarea");

            textarea.style.height = `${textarea.scrollHeight}px`;
            textarea.focus();
            textarea.setSelectionRange(
              textarea.value.length,
              textarea.value.length
            );

            textarea.addEventListener("input", function () {
              this.style.height = "auto";
              this.style.height = `${this.scrollHeight}px`;
            });

            editButton.classList.add("editing");
            editButton
              .querySelector("i")
              .classList.replace("fa-edit", "fa-save");
            editButton.querySelector("span").textContent = "ذخیره";
          }
          saveComments();
        }

        function showNotification(message, type) {
          const notification = document.createElement("div");
          notification.className = `notification ${type}`;
          notification.innerHTML = `
            <i class="fas ${
              type === "success" ? "fa-check-circle" : "fa-exclamation-circle"
            }"></i>
            <span>${message}</span>
        `;
          document.body.appendChild(notification);

          setTimeout(() => {
            notification.style.opacity = "0";
            setTimeout(() => notification.remove(), 300);
          }, 3000);
        }

        function updateStats() {
          totalCommentsEl.textContent = totalComments;
          totalLikesEl.textContent = totalLikes;
          checkEmptyState(); // بررسی وضعیت empty-state پس از به‌روزرسانی آمار
        }
        function checkEmptyState() {
          const comments = commentBox.querySelectorAll(".comment");
          const existingEmptyState = commentBox.querySelector(".empty-state"); // بررسی وجود empty-state قبلی

          if (comments.length === 0 && !existingEmptyState) {
            const emptyState = document.createElement("div");
            emptyState.classList.add("empty-state");
            emptyState.innerHTML = `
      <i class="far fa-comments"></i>
      <p>هنوز نظری ثبت نشده است</p>
      <span>اولین نفری باشید که نظر می‌دهید!</span>
    `;
            commentBox.appendChild(emptyState);
          } else if (comments.length > 0 && existingEmptyState) {
            existingEmptyState.remove(); // اگر نظری وجود دارد و empty-state نمایش داده می‌شود، آن را حذف کنید
          }
        }
        function saveComments() {
          const comments = commentBox.innerHTML;
          localStorage.setItem("comments", comments);
          localStorage.setItem(
            "stats",
            JSON.stringify({ totalComments, totalLikes })
          );
        }

        function loadComments() {
          const comments = localStorage.getItem("comments");
          const stats = JSON.parse(localStorage.getItem("stats") || "{}");

          if (comments) {
            commentBox.innerHTML = comments;
            totalComments = stats.totalComments || 0;
            totalLikes = stats.totalLikes || 0;
            document.querySelectorAll(".comment").forEach((comment) => {
              setupCommentActions(comment);
            });
          }
          checkEmptyState(); // بررسی وضعیت empty-state پس از بارگذاری نظرات
        }
      });
    </script>
  </body>
</html>
